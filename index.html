<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Midi Sound Engine</title>
		<style type="text/css">
			body {
				background: #000;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}
			label {
				color: #fff;
			}
			#playermidi {
				margin: 0;
				width: 360px;
				height: 230px;
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				border: 2px solid #666;
			}
		</style>
	</head>
	<body id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
		<div id="playermidi">
			<button id="loadmidifile">Load Mid</button>
			<button id="playstop">Play/Pause</button>
			<label id="cuer">0:00/0:00</label>
			<canvas width="360" height="210" id="midiscene"></canvas>
		</div>
		<script type="text/javascript" src="midi.js"></script>
		<script type="text/javascript">
			var MSE = new MidSE.MidiSoundEngine();
			window.MSE = MSE;
			var cuer = document.getElementById('cuer');
			function mod(x, y) {
				var r = x % y;
				if (r / y < 0) {
				r += y;
				}
				return r; 
			};
			function getDuraction(num) {
				var txt = '';
				if (Math.floor(num) > 3599) {
					txt += '' + Math.floor(num / 3600);
					txt += ':';
					if (mod(Math.floor(num / 60), 60) > 9) {
						txt += '' + mod(Math.floor(num / 60), 60);
					} else {
						txt += '0' + mod(Math.floor(num / 60), 60);
					}
					txt += ':';
					if (mod(Math.floor(num), 60) > 9) {
						txt += '' + mod(Math.floor(num), 60);
					} else {
						txt += '0' + mod(Math.floor(num), 60);
					}
				} else {
					txt += '' + mod(Math.floor(num / 60), 60);
					txt += ':';
					if (mod(Math.floor(num), 60) > 9) {
						txt += '' + mod(Math.floor(num), 60);
					} else {
						txt += '0' + mod(Math.floor(num), 60);
					}
				}
				return txt;
			}
			function z_dir(dx,dy) {
				return Math.sqrt((dx * dx) + (dy * dy));
			}
			class MidiControls {
				constructor(mse, canvas) {
					this.mse = mse;
					this.canvas = canvas;
					this.ctx = this.canvas.getContext('2d');
					this.step = this.step.bind(this);
					this.interval = setInterval(this.step, 1000 / 60);
		            this.onmousedown = this.onmousedown.bind(this);
		            this.onmouseup = this.onmouseup.bind(this);
		            this.onmousemove = this.onmousemove.bind(this);
					this.mouseX = 0;
					this.mouseY = 0;
					this.playNote = [];
					this.mousePressed = false;
		            this.mse.duration = 0;
		            this.visualizer = new Array(32);
		            this.visualizer2 = new Array(32);
		            this.onplaynote = this.onplaynote.bind(this);
		            this.mse.onplaynote = this.onplaynote;
		            this.onprogress = this.onprogress.bind(this);
					mse.onprogress = this.onprogress;
		            this.textprogress = "";
					for (var i = 0; i < 32; i++) {
						this.visualizer[i] = 0;
						this.visualizer2[i] = 0;
					}
	                document.addEventListener('mousedown', this.onmousedown);
					document.addEventListener('mouseup', this.onmouseup);
                	document.addEventListener('mousemove', this.onmousemove);
				}
				onprogress(e) {
		            this.textprogress = e;
				}
				onplaynote(e) {
					if (e.type == 1) this.playNote.push(e);
				}
				playStop() {
					this.playNote = [];
					if (this.mse.isPaused) {
						this.mse.play();
					} else {
						this.mse.pause();
					}
				}
				step() {
					for (var i6 = 0; i6 < 32; i6++) {
						this.visualizer[i6] = 0;
					}
					for (var i4 = 0; i4 < this.playNote.length; i4++) {
						var s3 = this.playNote[i4];
						if (!("starttime" in s3)) {
							s3.starttime = this.mse.getTime();
						}
						if ((this.mse.getTime() - s3.starttime) >= s3.dur) {
							s3.ter = true;
						}
						var s = Math.floor(((s3.pitch - 24) / 3));
						if (s in this.visualizer) this.visualizer[s] += (s3.volume * 5);
					}
					var ds = [];
					for (var i5 = 0; i5 < this.playNote.length; i5++) {
						var s2 = this.playNote[i5];
						if (!s2.ter) {
							ds.push(s2);
						}
					}
					for (var i1 = 0; i1 < 32; i1++) {
						this.visualizer2[i1] += ((this.visualizer[i1] - this.visualizer2[i1]) / 4);
					}
					this.playNote = ds;
					cuer.innerHTML = getDuraction(this.mse.getTime()) + '/' + getDuraction(this.mse.duration);
					var duH1 = (this.mse.getTime() / this.mse.duration);
					this.ctx.clearRect(0, 0, 360, 210);
					this.ctx.strokeStyle = "#555";
					this.ctx.beginPath();
					this.ctx.lineCap = "round";
					this.ctx.lineWidth = 12;
					this.ctx.moveTo(16, 16);
					this.ctx.lineTo(344, 16);
					this.ctx.stroke();
					this.ctx.strokeStyle = "#FFF";
					this.ctx.beginPath();
					this.ctx.lineCap = "round";
					this.ctx.lineWidth = 12;
					this.ctx.moveTo(16, 16);
					this.ctx.lineTo(16 + (duH1 * (360 - 32)), 16);
					this.ctx.stroke();
					this.ctx.fillStyle = '#fff';
					this.ctx.font = "14px Arial";
					this.ctx.textAlign = "center";
					this.ctx.fillText(this.textprogress, 180, 66);
					var g = (16 + (duH1 * (360 - 32)));
					var radius = z_dir(g - this.mouseX, 16 - this.mouseY);
					this.ctx.lineWidth = 18;
					if (radius < 12 || this.isTimelineTime) {
						this.ctx.beginPath();
						this.ctx.lineCap = "round";
						this.ctx.strokeStyle = "#FFF";
						this.ctx.moveTo(16 + (duH1 * (360 - 32)), 16);
						this.ctx.lineTo(16 + (duH1 * (360 - 32)), 16);
						this.ctx.stroke();
					}
					for (var i2 = 0; i2 < 32; i2++) {
						this.ctx.fillStyle = "hsl(" + ((i2 / 32) * 400) + ", 100%, 50%)";
						var o = this.visualizer2[i2] * 10;
						if (o > 178) o = 178;
						this.ctx.fillRect(8 + (i2 * 10.8), (210 - 8) - o, 10.8, o);
					}
					if (!(this.mousePressed == true)) {
						this.isTimelineTime = false;
					}
					if (radius < 12 && this.mousePressed) {
						this.isTimelineTime = true;
					}
					if (this.isTimelineTime) {
						for (var i3 = 0; i3 < 32; i3++) {
							this.visualizer[i3] = 0;
							this.visualizer2[i3] = 0;
						}
						this.playNote = [];
						this.mse.setCurrentTime((((this.mouseX - 16) / (360 - 32)) * this.mse.duration));
					}
				}
				onmousemove(e) {
					var rect = this.canvas.getBoundingClientRect();
					var x = (e.clientX - rect.left);
					var y = (e.clientY - rect.top);
					this.mouseX = x;
					this.mouseY = y;
				}
				onmousedown(e) {
					this.mousePressed = true;
				}
				onmouseup(e) {
					this.mousePressed = false;
				}
			}
			var midcontrol = new MidiControls(MSE, document.getElementById('midiscene'));
			function loadMidiFile(file) {
				var a = new FileReader();
				a.onload = (function() {
					midcontrol.playNote = [];
					MSE.loadMid(a.result);
					MSE.loadSoundbank().then(function(e) {
						MSE.play();
					})
				}).bind(this);
				a.readAsArrayBuffer(file);
			}
			var loadmidifile = document.getElementById('loadmidifile');
			var playstop = document.getElementById('playstop');
			function dropHandler(ev) {
				ev.preventDefault();
				if (ev.dataTransfer.items) {
					[...ev.dataTransfer.items].forEach((item, i) => {
					if (item.kind === 'file') {
						const file = item.getAsFile();
						loadMidiFile(file);
					}
					});
				}
			}
			function dragOverHandler(ev) {
				ev.preventDefault();
			}
			loadmidifile.onclick = function () {
				var sa = document.createElement('input');
				sa.type = 'file';
				sa.accept = '.mid';
				sa.addEventListener('change', function (e) {
					var file = e.target.files[0];
					loadMidiFile(file);
				}, false);
				sa.click();
			}
			playstop.onclick = function () {
				midcontrol.playStop();
			}
		</script>
	</body>
</html>