<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Midi Sound Engine</title>
		<style type="text/css">
			body {
				background: #000;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}
			label {
				color: #fff;
			}
			#playermidi {
				margin: 0;
				width: 360px;
				height: 230px;
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				border: 2px solid #666;
			}
		</style>
	</head>
	<body id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
		<div id="playermidi">
			<button id="loadmidifile">Load Mid</button>
			<button id="playstop">Play/Pause</button>
			<label id="cuer">0:00/0:00</label>
			<canvas width="360" height="210" id="midiscene"></canvas>
		</div>
		<div style="position: absolute; bottom: 0%; left: 50%; transform: translate(-50%, 0%); padding: 8px; color: #fff;">
			<a>Midi Visualisation</a>
			<a href="blackmidi.html">Black Midi</a>
		</div>
		<script type="text/javascript" src="midi.js"></script>
		<script type="text/javascript">
			var MSE = new MidSE.MidiSoundEngine();
			window.MSE = MSE;
			var cuer = document.getElementById('cuer');
			function mod(x, y) {
				var r = x % y;
				if (r / y < 0) {
				r += y;
				}
				return r; 
			};
			function getDuraction(num) {
				var txt = '';
				if (Math.floor(num) > 3599) {
					txt += '' + Math.floor(num / 3600);
					txt += ':';
					if (mod(Math.floor(num / 60), 60) > 9) {
						txt += '' + mod(Math.floor(num / 60), 60);
					} else {
						txt += '0' + mod(Math.floor(num / 60), 60);
					}
					txt += ':';
					if (mod(Math.floor(num), 60) > 9) {
						txt += '' + mod(Math.floor(num), 60);
					} else {
						txt += '0' + mod(Math.floor(num), 60);
					}
				} else {
					txt += '' + mod(Math.floor(num / 60), 60);
					txt += ':';
					if (mod(Math.floor(num), 60) > 9) {
						txt += '' + mod(Math.floor(num), 60);
					} else {
						txt += '0' + mod(Math.floor(num), 60);
					}
				}
				return txt;
			}
			function z_dir(dx,dy) {
				return Math.sqrt((dx * dx) + (dy * dy));
			}
			class MidiControls {
				constructor(mse, canvas) {
					this.mse = mse;
					this.canvas = canvas;
					this.ctx = this.canvas.getContext('2d');
					this.step = this.step.bind(this);
					this.interval = setInterval(this.step, 1000 / 60);
		            this.onmousedown = this.onmousedown.bind(this);
		            this.onmouseup = this.onmouseup.bind(this);
		            this.onmousemove = this.onmousemove.bind(this);
					this.mouseX = 0;
					this.mouseY = 0;
					this._counter = 0;
					this._rotation = 0;
					this.playNote = [];
					this.mousePressed = false;
		            this.mse.duration = 0;
		            this.onplaynote = this.onplaynote.bind(this);
		            this.mse.onplaynote = this.onplaynote;
		            this.onprogress = this.onprogress.bind(this);
					mse.onprogress = this.onprogress;
		            this.textprogress = "";
					this.ontouchstart = this.ontouchstart.bind(this);
					this.ontouchend = this.ontouchend.bind(this);
					this.ontouchmove = this.ontouchmove.bind(this);
					this.isTouch = ("ontouchstart" in window);
					this.touchVis = !this.isTouch;
					document.addEventListener('mousedown', this.onmousedown);
					document.addEventListener('mouseup', this.onmouseup);
					document.addEventListener('mousemove', this.onmousemove);
					document.addEventListener('touchstart', this.ontouchstart);
					document.addEventListener('touchend', this.ontouchend);
					document.addEventListener('touchmove', this.ontouchmove);
				}
				ontouchmove(e) {
					var rect = this.canvas.getBoundingClientRect();
					var gh = e.changedTouches[0];
					if (gh) {
						var x = (gh.clientX - rect.left);
						var y = (gh.clientY - rect.top);
						this.mouseX = x;
						this.mouseY = y;
					}
				}
				ontouchstart(e) {
					this.mousePressed = true;
					this.touchVis = true;
				}
				ontouchend(e) {
					this.mousePressed = false;
					this.touchVis = false;
					if (this.isTouch) {
						this.mouseX = -900;
						this.mouseY = -900;
					}
				}
				onprogress(e) {
		            this.textprogress = e;
				}
				onplaynote(e) {
					if (this.playNote.length >= 1000) {
						return;
					}
					if (e.type == 1) {
						this.playNote.push({
							pitch: 32 + ((e.pitch - 32) / 2),
							volume: e.volume,
							color: e.instrument,
							duration: Math.max(0.3, e.dur),
							d: Math.max(0.3, e.dur),
							du: Math.max(0.3, e.dur),
							de: 0,
							c: this._counter,
						});
					} else {
						this.playNote.push({
							pitch: 50,
							duration: 0.3,
							d: 0.3,
							color: e.drum,
							volume: e.volume,
							du: 0.3,
							de: 0,
							c: this._counter,
						});
					}
					this._counter += 32;
				}
				playStop() {
					this.playNote = [];
					if (this.mse.isPaused) {
						this.mse.play();
					} else {
						this.mse.pause();
					}
				}
				step() {
					var ds = [];
					for (var i5 = 0; i5 < this.playNote.length; i5++) {
						var s2 = this.playNote[i5];
						if (s2.duration > 0) {
							ds.push(s2);
						}
					}
					this._rotation = this.mse.getTime() * 50;
					this.playNote = ds;
					cuer.innerHTML = getDuraction(this.mse.getTime()) + '/' + getDuraction(this.mse.duration);
					var duH1 = (this.mse.getTime() / this.mse.duration);
					this.ctx.clearRect(0, 0, 360, 210);
					this.ctx.globalAlpha = 1;
					this.ctx.save();
					this.ctx.rect(10, 30, 340, 170);
					this.ctx.clip();
					for (var i2 = 0; i2 < this.playNote.length; i2++) {
						var o = this.playNote[i2];
						this.ctx.save();
						var r = [0, 0];
						r[0] = (Math.sin((o.c + this._rotation) * Math.PI / 180)) * ((20 + (o.d * 20)) * (o.volume * 1.5));
						r[1] = (Math.cos((o.c + this._rotation) * Math.PI / 180)) * ((20 + (o.d * 20)) * (o.volume * 1.5));
						o.d -= (0.4 / 60);
						this.ctx.translate(180 + r[0], 115 + r[1]);
						this.ctx.fillStyle = "hsl(" + (o.color * 15) + ", 100%, " + o.pitch + "%)"; 
						this.ctx.globalAlpha = o.duration / o.du;
						this.ctx.beginPath();
						this.ctx.arc(0, 0, (o.duration * 25) * o.volume, 0, 2 * Math.PI);
						this.ctx.fill();
						this.ctx.restore();
						o.duration -= (1 / 60);
					}
					this.ctx.globalAlpha = 1;
					this.ctx.restore();
					this.ctx.strokeStyle = "#555";
					this.ctx.beginPath();
					this.ctx.lineCap = "round";
					this.ctx.lineWidth = 12;
					this.ctx.moveTo(16, 16);
					this.ctx.lineTo(344, 16);
					this.ctx.stroke();
					this.ctx.strokeStyle = "#FFF";
					this.ctx.beginPath();
					this.ctx.lineCap = "round";
					this.ctx.lineWidth = 12;
					this.ctx.moveTo(16, 16);
					this.ctx.lineTo(16 + (duH1 * (360 - 32)), 16);
					this.ctx.stroke();
					this.ctx.fillStyle = '#fff';
					this.ctx.font = "14px Arial";
					this.ctx.textAlign = "center";
					this.ctx.fillText(this.textprogress, 180, 66);
					var g = (16 + (duH1 * (360 - 32)));
					var radius = z_dir(g - this.mouseX, 16 - this.mouseY);
					this.ctx.lineWidth = 18;
					if (this.touchVis && (radius < 12 || this.isTimelineTime)) {
						this.ctx.beginPath();
						this.ctx.lineCap = "round";
						this.ctx.strokeStyle = "#FFF";
						this.ctx.moveTo(16 + (duH1 * (360 - 32)), 16);
						this.ctx.lineTo(16 + (duH1 * (360 - 32)), 16);
						this.ctx.stroke();
					}
					if (!(this.mousePressed == true)) {
						this.isTimelineTime = false;
					}
					if (radius < 12 && this.mousePressed) {
						this.isTimelineTime = true;
					}
					if (this.isTimelineTime) {
						this.playNote = [];
						this.mse.setCurrentTime((((this.mouseX - 16) / (360 - 32)) * this.mse.duration));
					}
				}
				onmousemove(e) {
					var rect = this.canvas.getBoundingClientRect();
					var x = (e.clientX - rect.left);
					var y = (e.clientY - rect.top);
					this.mouseX = x;
					this.mouseY = y;
				}
				onmousedown(e) {
					this.mousePressed = true;
				}
				onmouseup(e) {
					this.mousePressed = false;
				}
			}
			var midcontrol = new MidiControls(MSE, document.getElementById('midiscene'));
			function loadMidiFile(file) {
				var a = new FileReader();
				a.onload = (function() {
					midcontrol.playNote = [];
					MSE.loadMid(a.result);
					MSE.loadSoundbank().then(function(e) {
						MSE.play();
					})
				}).bind(this);
				a.readAsArrayBuffer(file);
			}
			var loadmidifile = document.getElementById('loadmidifile');
			var playstop = document.getElementById('playstop');
			function dropHandler(ev) {
				ev.preventDefault();
				if (ev.dataTransfer.items) {
					[...ev.dataTransfer.items].forEach((item, i) => {
					if (item.kind === 'file') {
						const file = item.getAsFile();
						loadMidiFile(file);
					}
					});
				}
			}
			function dragOverHandler(ev) {
				ev.preventDefault();
			}
			loadmidifile.onclick = function () {
				var sa = document.createElement('input');
				sa.type = 'file';
				sa.accept = '.mid';
				sa.addEventListener('change', function (e) {
					var file = e.target.files[0];
					loadMidiFile(file);
				}, false);
				sa.click();
			}
			playstop.onclick = function () {
				midcontrol.playStop();
			}
		</script>
	</body>
</html>
